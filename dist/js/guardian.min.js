!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Guardian={})}(this,(function(e){"use strict";class t{constructor(e={}){this.initialized=!1,this.signals=new Map,this.behavior={mouseMovements:0,mousePositions:[],mouseMovementCount:0,clicks:0,clickPositions:[],clickCount:0,scrolls:0,scrollEvents:[],scrollCount:0,keystrokes:0,keystrokeCount:0,keystrokeTimings:[],lastKeystrokeTime:0},this.reported=!1,this.config={endpoint:"/__guardian__/report",threshold:75,sampleRate:.1,detectionDelay:2e3,debug:!1,throttleDelay:100,maxArraySize:50},void 0!==e.sampleRate&&(e.sampleRate=Math.max(0,Math.min(1,e.sampleRate))),void 0!==e.threshold&&(e.threshold=Math.max(0,e.threshold)),void 0!==e.detectionDelay&&(e.detectionDelay=Math.max(0,e.detectionDelay)),this.config=Object.assign(Object.assign({},this.config),e),this.initEventListeners()}initEventListeners(){const e=this.throttle((e=>{this.behavior.mouseMovements++,this.behavior.mousePositions.push({x:e.clientX,y:e.clientY,timestamp:Date.now()}),this.limitArraySize(this.behavior.mousePositions),this.behavior.mouseMovementCount++,this.addSignal("mouse_movement",5,"Mouse movement detected")}),this.config.throttleDelay||100);document.addEventListener("mousemove",e),document.addEventListener("click",(e=>{this.behavior.clicks++,this.behavior.clickPositions.push({x:e.clientX,y:e.clientY,timestamp:Date.now()}),this.limitArraySize(this.behavior.clickPositions),this.behavior.clickCount++,this.addSignal("click",10,"Click detected")})),window.addEventListener("scroll",(()=>{this.behavior.scrolls++,this.behavior.scrollEvents.push({position:window.scrollY||0,timestamp:Date.now()}),this.limitArraySize(this.behavior.scrollEvents),this.behavior.scrollCount++,this.addSignal("scroll",5,"Scroll detected")})),document.addEventListener("keydown",(e=>{this.behavior.keystrokes++;const t=Date.now();this.behavior.lastKeystrokeTime>0&&(this.behavior.keystrokeTimings.push(t-this.behavior.lastKeystrokeTime),this.limitArraySize(this.behavior.keystrokeTimings)),this.behavior.lastKeystrokeTime=t,this.behavior.keystrokeCount++,this.addSignal("keyboard",15,"Keyboard input detected")}))}init(){var e;this.initialized||(this.initialized=!0,Math.random()<=(null!==(e=this.config.sampleRate)&&void 0!==e?e:.1)&&this.runDetection())}runDetection(){this.checkForFakeChrome(),this.checkForIframeEmbedding(),window._phantom&&this.addSignal("phantom",10,"PhantomJS detected"),window.__nightmare&&this.addSignal("nightmare",10,"Nightmare.js detected"),navigator.webdriver&&this.addSignal("webdriver",10,"Webdriver detected"),navigator.cookieEnabled||this.addSignal("cookies_disabled",7,"Cookies are disabled"),navigator.languages&&0!==navigator.languages.length||this.addSignal("no_languages",8,"No browser languages detected"),setTimeout((()=>{this.checkForNoMouseMovement(),this.checkForNoKeyboardUsage(),this.requestIdleCallback((()=>{this.checkForMechanicalMouseMovement(),this.checkForMechanicalScrolling(),this.checkForMechanicalTyping(),this.finalizeDetection()}))}),this.config.detectionDelay)}checkForFakeChrome(){navigator.userAgent.toLowerCase().includes("chrome")&&!window.chrome&&this.addSignal("fake_chrome",9,"Chrome detected in user agent but chrome object missing")}checkForIframeEmbedding(){try{window.top!==window.self&&this.addSignal("iframe_embedded",6,"Page is embedded in an iframe")}catch(e){this.addSignal("framed",6,"Page is framed and access to parent is blocked")}}checkForNoMouseMovement(){0===this.behavior.mouseMovements&&this.addSignal("no_mouse_movement",7,"No mouse movement detected")}checkForNoKeyboardUsage(){document.querySelectorAll('input[type="text"], textarea').length>0&&0===this.behavior.keystrokes&&this.addSignal("no_keyboard",7,"No keyboard usage detected despite having input fields")}checkForMechanicalMouseMovement(){if(this.behavior.mousePositions.length<5)return;let e=0;for(let t=1;t<this.behavior.mousePositions.length;t++){const i=this.behavior.mousePositions[t-1],o=this.behavior.mousePositions[t],s=(o.y-i.y)/(o.x-i.x||1e-4);Math.abs(s-1)<.1&&e++}e>=3&&this.addSignal("linear_mouse_movement",8,"Linear mouse movement pattern detected")}checkForMechanicalScrolling(){if(this.behavior.scrollEvents.length<3)return;let e=0;for(let t=1;t<this.behavior.scrollEvents.length;t++){const i=this.behavior.scrollEvents[t-1],o=this.behavior.scrollEvents[t],s=Math.abs(o.position-i.position);Math.abs(s-100)<5&&e++}e>=2&&this.addSignal("mechanical_scroll",8,"Mechanical scroll pattern detected")}checkForMechanicalTyping(){if(this.behavior.keystrokeTimings.length<3)return;let e=0;for(let t=0;t<this.behavior.keystrokeTimings.length;t++)40===this.behavior.keystrokeTimings[t]&&e++;e>=2&&this.addSignal("rapid_typing",8,"Mechanical typing pattern detected")}finalizeDetection(){var e;const t=this.getTotalScore();t>=(null!==(e=this.config.threshold)&&void 0!==e?e:75)&&!this.reported&&this.report(t)}report(e){var t;if(this.reported||0===e)return;const i={url:window.location.href,timestamp:Date.now(),score:e,signals:Array.from(this.signals.entries()).map((([e,t])=>({name:e,score:t.score,description:t.description}))),behavior:{mouseMovements:this.behavior.mouseMovements,clicks:this.behavior.clicks,scrolls:this.behavior.scrollEvents.length,keystrokes:this.behavior.keystrokes}},o=null!==(t=this.config.endpoint)&&void 0!==t?t:"/__guardian__/report";try{if(navigator.sendBeacon){if(navigator.sendBeacon(o,JSON.stringify(i)))return void(this.reported=!0)}const e=new XMLHttpRequest;e.open("POST",o,!0),e.setRequestHeader("Content-Type","application/json"),e.onload=()=>{e.status>=200&&e.status<300&&(this.reported=!0)},e.onerror=()=>{this.reported=!0},e.send(JSON.stringify(i))}catch(e){console.error("Failed to report detection:",e),this.reported=!0}}addCustomSignal(e,t,i){this.addSignal(e,t,i)}clearSignals(){this.signals.clear(),this.reported=!1}getResults(){return Array.from(this.signals.entries()).map((([e,{description:t}])=>{var i;return{name:e,weight:(null===(i=this.signals.get(e))||void 0===i?void 0:i.score)||0,description:t,timestamp:performance.now()}}))}getTotalScore(){let e=0;return this.signals.forEach((t=>{e+=t.score})),e}addSignal(e,t,i){var o;this.signals.set(e,{score:t,description:i});const s=this.getTotalScore();s>=(null!==(o=this.config.threshold)&&void 0!==o?o:75)&&this.report(s)}forceReport(){this.reported=!1,this.report(this.getTotalScore())}throttle(e,t){let i=0;return(...o)=>{const s=Date.now();s-i>=t&&(i=s,e(...o))}}limitArraySize(e){const t=this.config.maxArraySize||50;e.length>t&&e.splice(0,e.length-t)}requestIdleCallback(e){return"undefined"!=typeof window&&"requestIdleCallback"in window?window.requestIdleCallback(e):setTimeout(e,1)}}document.addEventListener("DOMContentLoaded",(()=>{(new t).init()})),e.Guardian=t}));
//# sourceMappingURL=guardian.min.js.map
